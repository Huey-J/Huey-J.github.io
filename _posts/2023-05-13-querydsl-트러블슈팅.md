---
title: 트러블 슈팅 - querydsl 문제
author: Huey-J
date: 2023-05-13 12:00:00 +0800
categories: [backend, spring]
tags: [spring, java, querydsl, 트러블슈팅]
---

# 상황

회사에서 겪은 트러블 슈팅 기록입니다. 회사 작업이기 때문에 코드를 적을 수는 없어서 다른 간략한 예시를 들어 설명하겠습니다.

## 엔티티 상황

간단한 예시로 가게(Shop)과 해당 가게에서 파는 물건(Goods)이 있습니다.

```java
@Entity
public class shop {
  @Id
  private Long id;
  private String name;
  private String ownerName;
}

@Entity
public class goods {
  @Id
  private Long id;
  private String name;
  private boolean activated;
  private int price;
  @ManyToOne
  private Shop shop;
}
```

## 요구 사항

- Shop의 목록을 조회
- Page<> 반환 (pagenation)
- 해당 Shop의 Goods 중에 activated=true인 총 금액과 같이 조회
- 해당되는 Goods가 없거나 총 금액이 0 이하인 경우 목록에서 제외
- 동적 쿼리 필요

# 접근

## 쿼리문 작성

```sql
--- from 절에 sub query 이용
SELECT sq.shop_id, sq.shop_name, sq.shop_owner_name, sq.total_goods_amount
FROM (
       SELECT shop.id         AS shop_id,
              shop.name       AS shop_name,
              shop.owner_name AS shop_owner_name,
              (
                SELECT COALESCE(SUM(goods.price), 0)
                FROM goods
                WHERE goods.activated = true
                  AND goods.shop_id = shop.id
              )               AS total_goods_amount
       FROM shop
     )
-- JOIN 문 생략
WHERE sq.total_goods_amount > 0
--   AND
--       동적 쿼리 생략...
;

--- group by 이용
SELECT shop.id, shop.name, shop.owner_name, COALESCE(SUM(goods.price), 0) AS total_goods_amount
FROM goods
       INNER JOIN shop
                  ON goods.shop_id = shop.id
-- JOIN 문 생략
GROUP BY shop.id, shop.name, shop.owner_name
HAVING total_goods_amount > 0
-- WHERE 동적 쿼리 생략...
;
```

sub query를 사용한 쿼리문과, group by를 사용한 쿼리문, 총 두개의 쿼리문을 작성했습니다.
당연히 두 번째 쿼리문이 모든 행을 조회하는 첫 번째 쿼리문 보다 더 효울적입니다.

> mysql 표준에 의하면 GROUP BY 질의에서 SELECT할 수 있는 컬럼은 다음과 같다.
>
> - GROUP BY에 나열된 컬럼
{: .prompt-tip }

# 문제 발생

요구 사항 중에 동적 쿼리가 있었기 때문에 querydsl로 개발하고자 하였습니다.\
하지만 query dsl로 작성하면서 두 쿼리문 모두 문제가 발생했습니다.

## 첫 번째 쿼리문 (sub query)

| 'JPQL에서 서브쿼리는 WHERE, HAVING 절에서만 사용할 수 있습니다.'

JPQL FROM 절 서브쿼리가 스펙상 불가능하다고 합니다. 따라서 개발하고자 한 Querydsl 에서도 불가능했습니다.

## 두 번째 쿼리문 (group by)

[https://github.com/querydsl/querydsl/issues/2504](https://github.com/querydsl/querydsl/issues/2504)

paging으로 반환하기 위해 fetchCount() 메소드를 사용했는데 에러가 발생했습니다.\
위의 깃허브 이슈를 보면 GroupBy로 2개 이상의 컬럼을 걸어줄 경우 JPQL로 변환 실패한다고 합니다.

# 해결

간단하게 native query를 사용하면 되겠지만 동적 쿼리가 걸렸고, pagenation을 포기하기도 어려웠습니다.

고민 끝에 querydsl을 native query로 변환해주는 클래스를 추가하여 해결하였습니다.

위 이슈에서 gudaoxuri 라는 분의 댓글에 jpaQuery를 serialize하여 native query로 변경하고 카운트 쿼리와 실제 쿼리문을 만들어주는 코드가 간단하게 있고, [https://myborn.tistory.com/26](https://myborn.tistory.com/26)의 글을 통해 작성이 가능합니다.


# 배운점 요약

- jpql에서는 생각보다 지원이 되지 않는게 많음.
- querydsl 도 native query로 변경할 수 있음.
